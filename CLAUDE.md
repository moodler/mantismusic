# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Project Overview

Mantis Music is a self-hosted, Spotify-style artist discography web application. Music is managed as files and folders under `/music`, compiled to JSON by a Python build script, and served as a vanilla JS single-page app. A Flask admin UI provides browser-based metadata editing. A native macOS app bundles everything into a standalone `.app`.

## Architecture

**Static Site (frontend):**
- `index.html` — Single-page app entry point (also has favicon, discography.js script tag)
- `js/app.js` — All application logic (data loading, rendering, filtering, audio player, queue, navigation)
- `css/style.css` — Complete styling with CSS custom properties for theming
- `data/discography.json` — Compiled music database (generated by build script)
- `data/discography.js` — Same data as `window._discographyData` for `file://` protocol support

**Build Pipeline (`build_music_json.py`):**
- Reads `/music` folder structure, compiles to `data/discography.json` and `data/discography.js`
- Generates `feed.rss` and `feed/*.html` (per-track pages for RSS readers)
- Generates `data/index.html` with OpenGraph/Twitter meta tags for deployment
- Updates root `index.html` with configured site title and cache-busting hashes on JS/CSS/data references
- Copies artist profile to `data/og-image.jpg` for social sharing
- Auto-links streaming URLs via Spotify, Apple Music, Tidal, and Deezer APIs
- Auto-detects MP3 duration via mutagen and writes back to track.md
- Optimizes oversized cover images to 1024x1024 using `sips` (macOS), preserving originals as `raw-{filename}`
- Config: `config.json` — site title, site URL, Spotify API credentials, deploy destination (gitignored)

**Path Resolution (`paths.py`):**
- Central module separating APP_DIR (bundled code) from DATA_DIR (user data)
- When running from source, both resolve to the script's parent directory
- When running as a PyInstaller `.app`, APP_DIR is `sys._MEIPASS` and DATA_DIR comes from the `MANTIS_DATA_DIR` environment variable
- Exports all path constants used by admin.py and build_music_json.py

**Admin UI:**
- `admin.py` — Flask app serving at localhost:5001. Imports all paths from `paths.py`
- `templates/` — Jinja2 templates for dashboard, track editor, collection editor, artist editor, settings page
- Static asset routes serve `/js/`, `/css/`, `/data/`, `/feed.rss`, `/feed/`, `/music/` from the correct directories (APP_DIR or DATA_DIR)
- Preview button builds JSON then opens browser via `file://` URL
- Build & Deploy button builds then rsyncs to configured remote server
- Image uploads support paste and file picker for jpg, png, gif, webp

**macOS App:**
- `mantis_app.py` — PyWebView wrapper. Prompts for a data directory on first run, creates the directory structure if empty, sets `MANTIS_DATA_DIR`, and launches the Flask admin in a native window
- `build_app.sh` — PyInstaller build script. Bundles templates, js, css, index.html, paths.py, build_music_json.py. Converts `icon.png` to `icon.icns` for the app icon (reconverts when source is newer)
- Links within the app must NOT use `target="_blank"` (opens Safari instead of staying in pywebview)

**Data Flow:**
1. Artist manages files under `/music` (tracks, collections, artist.md, images, audio, lyrics)
2. `build_music_json.py` compiles into `data/discography.json`, generates RSS feed, feed pages, and OG-tagged index.html
3. Frontend loads the JSON (via fetch or pre-loaded `window._discographyData` for file:// access) and renders the player
4. Audio files are served directly from `/music/tracks/`
5. Deploy rsyncs frontend assets from APP_DIR and user data from DATA_DIR to the remote server

**Key State Variables in app.js:**
- `discographyData` — Raw loaded JSON
- `allTracks` — Flattened track list (filtered by search/tags/year)
- `currentView` — Active navigation view ('tracks', 'collections', 'about')
- `navigationHistory` — Stack for back-button navigation between views
- `currentTrack`, `currentRelease` — Currently playing track and its parent release
- `queue` — Playback queue array of { track, release } objects

## Music Folder Structure

```
music/
├── artist/
│   ├── artist.md           # YAML frontmatter: name, social links. Body: bio text (supports markdown: links, bold, italic)
│   ├── profile.jpg         # Square profile image (also used as favicon and OG image)
│   └── banner.png          # Wide banner image (NOT processed by image optimizer)
├── tracks/
│   └── song_name/
│       ├── track.md        # YAML frontmatter: title, duration, tags, credits, streaming URLs. Body: description
│       ├── song_name.mp3   # Audio file (MP3 for streaming)
│       ├── song_name.wav   # Lossless audio (optional, offered as download)
│       ├── song_name.jpg   # Cover art (optional, optimized to 1024x1024 if oversized)
│       ├── raw-song_name.jpg  # Original high-res cover (auto-created by optimizer, not deployed)
│       └── song_name.txt   # Lyrics plain text (optional)
└── collections/
    └── album_name/
        ├── collection.md   # YAML frontmatter: title, type (album/ep), tracks list, streaming URLs. Body: description
        ├── album_name.jpg  # Cover art (optimized to 1024x1024 if oversized)
        └── raw-album_name.jpg  # Original high-res cover (auto-created, not deployed)
```

Collections reference tracks by folder slug. Tracks not in any collection appear as standalone singles.

## Important Implementation Notes

- `find_file()` in build script skips files starting with `.`, `raw-`, or `banner`
- `findTrackBySlug()` in app.js searches nested collection tracks first, then standalone singles (avoids slug collisions between EPs and their child tracks)
- `textToHtml()` in app.js supports markdown links `[text](url)`, **bold**, *italic*, and auto-links bare URLs
- Cache-busting: build appends `?v={md5hash}` to js/css/data script references in index.html
- Image optimizer uses macOS `sips` command — only runs once per image (skips if `raw-` version exists)
- `.deployignore` excludes `raw-*` files, Python scripts, config, templates, and other non-public files from rsync

## Development

```bash
python3 build_music_json.py    # Rebuild JSON, RSS, OG tags, optimize images
python3 -m http.server 8000    # Serve the site locally (or just open index.html in browser)
python3 admin.py               # Run admin UI on port 5001
bash build_app.sh              # Build native macOS .app
```

Dependencies (in requirements.txt): `pyyaml`, `mutagen`, `flask`, `requests`, `pywebview`, `pyinstaller`.
