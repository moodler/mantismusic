# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Project Overview

Mantis Music is a self-hosted, Spotify-style artist discography web application. Music is managed as files and folders under `/music`, compiled to JSON by a Python build script, and served as a vanilla JS single-page app. A Flask admin UI provides browser-based metadata editing. A native macOS app bundles everything into a standalone `.app`.

## Architecture

**Static Site:**
- `index.html` — Single-page app entry point
- `js/app.js` — All application logic (data loading, rendering, filtering, audio player, navigation)
- `css/style.css` — Complete styling with CSS custom properties for theming
- `data/discography.json` — Compiled music database (generated by build script)

**Build Pipeline:**
- `build_music_json.py` — Reads `/music` folder structure, compiles to `data/discography.json`. Also generates `feed.rss`, `feed/*.html` (per-track pages for RSS readers), `data/index.html` (with OpenGraph/Twitter meta tags), and `data/og-image.jpg`. Auto-links streaming URLs via Spotify, Apple Music, Tidal, and Deezer APIs.
- `config.json` — Site title, site URL, Spotify API credentials, deploy destination (gitignored).

**Path Resolution:**
- `paths.py` — Central path module separating APP_DIR (bundled code) from DATA_DIR (user data). When running from source both resolve to the script's parent directory. When running as a PyInstaller `.app`, APP_DIR is `sys._MEIPASS` and DATA_DIR comes from the `MANTIS_DATA_DIR` environment variable.

**Admin UI:**
- `admin.py` — Flask app serving at localhost:5001. Imports all paths from `paths.py`.
- `templates/` — Jinja2 templates for dashboard, track editor, collection editor, artist editor, settings page
- Static asset routes serve `/js/`, `/css/`, `/data/`, `/feed.rss`, `/feed/`, `/music/` from the correct directories (APP_DIR or DATA_DIR)

**macOS App:**
- `mantis_app.py` — PyWebView wrapper. Prompts for a data directory on first run, creates the directory structure if empty, sets `MANTIS_DATA_DIR`, and launches the Flask admin in a native window.
- `build_app.sh` — PyInstaller build script. Bundles templates, js, css, index.html, paths.py, build_music_json.py. Supports custom `icon.png`.

**Data Flow:**
1. Artist manages files under `/music` (tracks, collections, artist.md, images, audio, lyrics)
2. `build_music_json.py` compiles into `data/discography.json`, generates RSS feed, feed pages, and OG-tagged index.html
3. Frontend loads the JSON and renders the player
4. Audio files are served directly from `/music/tracks/`
5. Deploy rsyncs frontend assets from APP_DIR and user data from DATA_DIR to the remote server

**Key State Variables in app.js:**
- `discographyData` — Raw loaded JSON
- `allTracks` — Flattened track list (filtered by search/tags/year)
- `currentView` — Active navigation view ('tracks', 'collections', 'about')
- `navigationHistory` — Stack for back-button navigation between views
- `currentTrack`, `currentRelease` — Currently playing track and its parent release
- `queue` — Playback queue

## Music Folder Structure

```
music/
├── artist/
│   ├── artist.md           # YAML frontmatter: name, social links. Body: bio text
│   ├── profile.jpg         # Square profile image (also used as favicon and OG image)
│   └── banner.png          # Wide banner image
├── tracks/
│   └── song_name/
│       ├── track.md        # YAML frontmatter: title, duration, tags, credits, streaming URLs. Body: description
│       ├── song_name.mp3   # Audio file (MP3 for streaming)
│       ├── song_name.wav   # Lossless audio (optional, offered as download)
│       ├── song_name.jpg   # Cover art (optional)
│       └── song_name.txt   # Lyrics plain text (optional)
└── collections/
    └── album_name/
        ├── collection.md   # YAML frontmatter: title, type (album/ep), tracks list, streaming URLs. Body: description
        └── album_name.jpg  # Cover art
```

Collections reference tracks by folder slug. Tracks not in any collection appear as standalone singles.

## Development

```bash
python3 -m http.server 8000    # Serve the site locally
python3 build_music_json.py    # Rebuild JSON, RSS, OG tags from /music
python3 admin.py               # Run admin UI on port 5001
bash build_app.sh              # Build native macOS .app
```

Dependencies: `pyyaml`, `mutagen` (in requirements.txt), `flask` (for admin), `requests` (for streaming auto-link), `pyinstaller`, `pywebview` (for macOS app).
